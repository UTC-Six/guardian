# Guardian 黄反校验SDK 架构设计

## 系统架构

```
┌─────────────────────────────────────────────────────────────┐
│                    Guardian SDK                            │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │   Guardian  │  │ ContentFilter│  │   Cache     │        │
│  │   (API)     │  │             │  │             │        │
│  └─────────────┘  └─────────────┘  └─────────────┘        │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │AC Automaton │  │Nacos Client │  │   Types     │        │
│  │             │  │             │  │             │        │
│  └─────────────┘  └─────────────┘  └─────────────┘        │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │   Nacos Server  │
                    │  (Config Center)│
                    └─────────────────┘
```

## 核心组件

### 1. Guardian API层
- **位置**: `pkg/guardian/guardian.go`
- **职责**: 提供简洁的对外API接口
- **主要方法**:
  - `Check(text string) *FilterResult`: 基本文本检查
  - `CheckWithOptions(text, options) *FilterResult`: 带选项检查
  - `BatchCheck(texts []string) []*FilterResult`: 批量检查
  - `GetStats() map[string]interface{}`: 获取统计信息

### 2. ContentFilter 核心过滤层
- **位置**: `internal/filter/content_filter.go`
- **职责**: 核心过滤逻辑，协调各个组件
- **特性**:
  - 热加载支持
  - 白名单机制
  - 缓存集成
  - 并发安全

### 3. AC自动机算法
- **位置**: `internal/algorithm/ac_automaton.go`
- **职责**: 高效的敏感词匹配算法
- **特性**:
  - 时间复杂度: O(n + m + z)
  - 支持多模式匹配
  - 支持分类和级别过滤
  - 线程安全

### 4. Nacos客户端
- **位置**: `internal/nacos/client.go`
- **职责**: 与Nacos配置中心交互
- **特性**:
  - 配置获取和监听
  - 自动重连
  - 健康检查

### 5. 缓存层
- **位置**: `internal/cache/cache.go`
- **职责**: 提供高性能缓存
- **实现**:
  - 内存缓存 (MemoryCache)
  - LRU缓存 (LRUCache)
  - 自动过期清理

### 6. 类型定义
- **位置**: `internal/types/types.go`
- **职责**: 定义所有数据结构
- **主要类型**:
  - `FilterResult`: 过滤结果
  - `SensitiveWord`: 敏感词结构
  - `WordDatabase`: 词库结构
  - `Config`: 配置结构

## 数据流

### 1. 初始化流程
```
1. 创建Guardian实例
2. 初始化Nacos客户端
3. 从Nacos加载词库配置
4. 构建AC自动机
5. 启动配置监听
6. 启动定期重载
```

### 2. 文本检查流程
```
1. 接收检查请求
2. 检查缓存
3. 检查白名单
4. 标准化文本
5. AC自动机匹配
6. 收集结果
7. 更新缓存
8. 返回结果
```

### 3. 热加载流程
```
1. Nacos配置变更通知
2. 解析新配置
3. 更新AC自动机
4. 清空缓存
5. 更新版本信息
```

## 性能优化

### 1. 算法优化
- **AC自动机**: 一次扫描匹配所有模式
- **失败指针**: 避免重复匹配
- **输出合并**: 减少内存分配

### 2. 缓存优化
- **LRU策略**: 自动淘汰最少使用的项
- **TTL机制**: 自动过期清理
- **并发安全**: 读写锁保护

### 3. 内存优化
- **对象池**: 复用对象减少GC压力
- **字符串优化**: 避免不必要的字符串分配
- **结构体对齐**: 优化内存布局

## 并发安全

### 1. 读写锁
- 读操作使用读锁，支持并发
- 写操作使用写锁，独占访问
- 配置更新时使用写锁

### 2. 原子操作
- 版本号更新使用原子操作
- 统计信息使用原子计数器
- 状态标志使用原子布尔值

### 3. 无锁设计
- 关键路径避免锁竞争
- 使用channel进行协程通信
- 单生产者单消费者模式

## 扩展性设计

### 1. 插件化架构
- 算法可插拔 (AC自动机、Trie树等)
- 缓存可插拔 (内存、Redis等)
- 配置中心可插拔 (Nacos、Apollo等)

### 2. 配置驱动
- 所有行为通过配置控制
- 支持动态配置更新
- 配置版本管理

### 3. 监控集成
- 内置统计信息
- 支持Prometheus指标
- 健康检查接口

## 部署架构

### 1. 单机部署
```
┌─────────────────┐
│   Guardian SDK  │
│                 │
│  ┌───────────┐  │
│  │   Cache   │  │
│  └───────────┘  │
└─────────────────┘
         │
         ▼
┌─────────────────┐
│  Nacos Server   │
└─────────────────┘
```

### 2. 集群部署
```
┌─────────────┐  ┌─────────────┐  ┌─────────────┐
│ Guardian-1  │  │ Guardian-2  │  │ Guardian-N  │
└─────────────┘  └─────────────┘  └─────────────┘
         │               │               │
         └───────────────┼───────────────┘
                         ▼
                ┌─────────────────┐
                │  Nacos Cluster  │
                └─────────────────┘
```

### 3. 微服务部署
```
┌─────────────┐    ┌─────────────┐
│   Gateway   │    │   Gateway   │
└─────────────┘    └─────────────┘
         │               │
         ▼               ▼
┌─────────────┐    ┌─────────────┐
│ Guardian-1  │    │ Guardian-2  │
└─────────────┘    └─────────────┘
         │               │
         └───────────────┘
                 │
                 ▼
        ┌─────────────────┐
        │  Nacos Cluster  │
        └─────────────────┘
```

## 监控指标

### 1. 性能指标
- 请求延迟 (P50, P90, P99)
- 吞吐量 (QPS)
- 错误率
- 缓存命中率

### 2. 业务指标
- 敏感词匹配数
- 分类分布
- 白名单命中数
- 配置更新次数

### 3. 系统指标
- 内存使用量
- CPU使用率
- 协程数量
- GC频率

## 故障处理

### 1. 降级策略
- Nacos不可用时使用本地配置
- 缓存不可用时直接查询
- 自动机构建失败时使用简单匹配

### 2. 重试机制
- 配置获取失败自动重试
- 网络异常指数退避重试
- 最大重试次数限制

### 3. 熔断保护
- 连续失败达到阈值时熔断
- 熔断期间返回默认结果
- 定期尝试恢复服务
